{% extends '../_base.html' %}

{% block nav %} /category/{{ article.category_id }} {% endblock %}

{% block meta %}
    <meta property="og:type" content="article" />
    <meta property="og:url" content="http://{{ __request__.host }}/article/{{ article.id }}" />
    <meta property="og:title" content="{{ article.name }}" />
    <meta property="og:description" content="{{ article.name }}" />
    <meta property="og:image" content="http://{{ __request__.host }}/files/attachments/{{ article.cover_id }}/l" />
{% endblock %}

{% block title %}{{ article.name }}{% endblock %}

{% block head %}
    {% set __sidebar_right__ = true %}

<script>
loadComments('{{ article.id }}');

var
    comment_type = 'article',
    comment_ref_id = '{{ article.id }}',
    comment_tag = '{{ category.tag }}';

var model = {
    article: {
        id: '{{ article.id }}',
        category_id: '{{ article.category_id }}',
        cover_id: '{{ article.cover_id }}',
        cover_url: 'http://{{ __request__.host }}/files/attachments/{{ article.cover_id }}/l',
        name: {{ article.name|json|safe }},
        description: {{ article.description|json|safe }},
        user_id: '{{ article.user_id }}',
        user_name: {{ article.user_name|json|safe }}
    }
};

function onAuthSuccess() {
    initCommentArea('article', '{{ article.id }}', '{{ category.tag }}');
}

function initCommentArea(ref_type, ref_id, tag) {
    console.log('auth success, display comment form...');
    var $makeComment = $('#comment-make-button');
    var $commentForm = $('#comment-form');
    var $postComment = $commentForm.find('button[type=submit]');
    var $cancelComment = $commentForm.find('button.x-cancel');
    $makeComment.click(function () {
        $commentForm.showFormError();
        $commentForm.show();
        $commentForm.find('div.x-textarea').html('<textarea></textarea>');
        var htmleditor = UIkit.htmleditor($commentForm.find('textarea').get(0), {
            mode: 'split',
            maxsplitsize: 600,
            markdown: true,
            lblCodeview: '{{ _('Input') }}',
            lblPreview: '{{ _('Preview') }}'
        });
        $makeComment.hide();
    });
    $cancelComment.click(function () {
        $commentForm.find('div.x-textarea').html('');
        $commentForm.hide();
        $makeComment.show();
    });
    $commentForm.submit(function (e) {
        e.preventDefault();
        $commentForm.postJSON('/api/comments/' + ref_type + '/' + ref_id, {
            tag: tag,
            name: $commentForm.find('input[name=name]').val(),
            content: $commentForm.find('textarea').val()
        }, function (err, result) {
            if (err) {
                return;
            }
            refresh();
        });
    });
}
$(function () {
    if (g_user !== null) {
        initCommentArea('article', '{{ article.id }}', '{{ category.tag }}');
    }
});

</script>
{% endblock %}

{% block main_content %}

    <h3>{{ article.name }}</h3>
    <p><img src="/files/attachments/{{ article.cover_id }}/l" class="uk-responsive-width"></p>
    <p><a href="/user/{{ article.user_id }}">{{ article.user_name|e }}</a> / <a href="/category/{{ article.category_id }}">{{ category.name|e }}</a> / <span class="x-smartdate" date="{{ article.publish_at }}">...</span> / {{ _('Reads') }}: {{ article.reads }}</p>
    <div class="x-article-content x-content">
        {{ article.content|safe }}
    </div>

    <h3>{{ _('Comments') }}</h3>

    <ul id="x-comment-list" class="uk-comment-list">
    </ul>

    <h3>Make a Comment</h3>

    <div class="x-display-if-not-signin">
        <p><button type="button" class="uk-button" onclick="showSignin()"><i class="uk-icon-signin"></i> Sign In to Make a Comment</button></p>
    </div>

    <div class="x-display-if-signin">
        <p><button id="comment-make-button" type="button" class="uk-button uk-button-primary"><i class="uk-icon-comment"></i> Make a Comment</button></p>
        <form id="comment-form" class="uk-form" style="display:none;">
            <fieldset>
                <div class="uk-alert uk-alert-danger" style="display:none"></div>
                <div class="uk-form-row">
                    <label>Title:</label>
                </div>
                <div class="uk-form-row">
                    <input type="text" name="name" maxlength="100" style="width:100%">
                </div>
                <div class="uk-form-row">
                    <label>Content:</label>
                </div>
                <div class="uk-form-row x-textarea">
                </div>
                <div class="uk-form-row">
                    <button type="submit" class="uk-button uk-button-primary"><i class="uk-icon-check"></i> Post</button>
                    &nbsp;&nbsp;
                    <button type="button" class="uk-button x-cancel"><i class="uk-icon-close"></i> Cancel</button>
                </div>
            </fieldset>
        </form>
    </div>

{% endblock %}

{% block sidebar %}
    <div class="x-sidebar-section">
        <h4>喜欢这篇文章？</h4>
        <div style="height:66px">
            <wb:like appkey="2f89Ml"></wb:like>
        </div>
    </div>
    <div class="x-sidebar-section">
        <h4>分享给朋友</h4>
        <div style="height:66px">
            <wb:share-button appkey="2f89Ml" addition="full" type="button" default_text="{{ article.name }}：{{ article.description }}" ralateUid="1658384301" pic="http://{{ __request__.host }}/files/attachments/{{ article.cover_id }}/0" picture_search="false"></wb:share-button>
        </div>
    </div>
    <div class="x-sidebar-section">
        <h4>关于作者</h4>
        <iframe width="278" height="330" class="share_self" frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=zh_cn&width=278&height=330&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=1&isFans=1&uid=1658384301&verifier=078cedea&colors=0088cc,ffffff,333333,0082cb,d14836&dpc=1&rnd={{ __time__ }}"></iframe>
    </div>
{% endblock %}
